<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Medication Taper Schedule</title>
<style>
  body { font-family: system-ui, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
  h1, h2 { font-size:1.4rem; margin:0 0 10px; }
  label { display:block; margin-top:10px; }
  input, select, button { padding:8px; margin-top:4px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .card { background:#111827; padding:16px; border-radius:10px; margin-bottom:20px; border:1px solid #1f2937; }
  .output { white-space:pre-line; background:#0b1220; padding:16px; border-radius:10px; border:1px solid #1f2937; }
  .output div { margin-bottom:14px; }
  .note { font-size:.9rem; color:#94a3b8; margin-top:10px; }
  .dose-section { margin-top:15px; padding:12px; border:1px solid #1f2937; border-radius:8px; background:#0d1426; }
  .grid { display:grid; gap:10px; grid-template-columns: repeat(4, minmax(0, 1fr)); }
  .grid-3 { display:grid; gap:10px; grid-template-columns: repeat(3, minmax(0, 1fr)); }
  @media (max-width: 900px) { .grid, .grid-3 { grid-template-columns: 1fr; } }
  .muted { color:#94a3b8; font-size:.9rem; }
</style>
</head>
<body>
  <h1>Medication Taper Schedule</h1>

  <div class="card">
    <div class="grid-3">
      <label>Medication name
        <input id="medName" type="text" value="Prednisolone" />
      </label>
      <label>Dosage form
        <select id="dosageForm">
          <option value="tablet">Tablets</option>
          <option value="capsule">Capsules</option>
        </select>
      </label>
      <label>Available strengths (mg, comma-separated)
        <input id="strengths" type="text" value="5,1" />
      </label>
    </div>

    <div class="grid-3">
      <label>Interval length (days)
        <input id="intervalDays" type="number" min="1" step="1" value="7" />
      </label>
      <label>Number of dosing times per day
        <input id="numTimes" type="number" min="1" max="8" value="1" />
      </label>
      <div style="align-self:end">
        <button id="setupTimes">Set up times</button>
      </div>
    </div>

    <div id="timesContainer"></div>

    <div class="grid-3" style="margin-top:12px">
      <label>Default mode for new times
        <select id="globalDirection">
          <option value="down" selected>Reduce</option>
          <option value="up">Increase</option>
          <option value="hold">Hold constant</option>
        </select>
      </label>
      <label>Default step (mg per interval)
        <input id="globalStep" type="number" step="0.5" value="5" />
      </label>
      <div class="muted" style="align-self:end">Each time can override mode & step.</div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="buildBtn">Build schedule</button>
      <button id="exportPDF">Export PDF</button>
      <button id="exportWord">Export Word</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h2>Schedule</h2>
    <div id="output" class="output">Choose “Set up times”, enter doses, then Build.</div>
    <div id="warnings" class="note"></div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
<script>
/* Utilities */
function numberToWordsUpper(n) {
  n = Math.floor(Math.abs(n));
  const LT20 = ["ZERO","ONE","TWO","THREE","FOUR","FIVE","SIX","SEVEN","EIGHT","NINE","TEN",
                "ELEVEN","TWELVE","THIRTEEN","FOURTEEN","FIFTEEN","SIXTEEN","SEVENTEEN","EIGHTEEN","NINETEEN"];
  const TENS = ["","","TWENTY","THIRTY","FORTY","FIFTY","SIXTY","SEVENTY","EIGHTY","NINETY"];
  if (n < 20) return LT20[n];
  if (n < 100) { const ten=Math.floor(n/10), unit=n%10; return TENS[ten]+(unit?("-"+LT20[unit]):""); }
  if (n < 1000) { const hund=Math.floor(n/100), rest=n%100; return LT20[hund]+" HUNDRED"+(rest?(" "+numberToWordsUpper(rest)):""); }
  return n.toString();
}
const defaults = ["Morning","Afternoon","Evening","Bedtime"];
const plural = (n, word) => n===1 ? word : (word+"s");
function formatMg(x) { return (Math.round(x) === x) ? String(Math.round(x)) : String(x); }

/* Build schedule */
function buildSchedule() {
  const medName = document.getElementById('medName').value || "Medication";
  const formWord = document.getElementById('dosageForm').value;
  const strengths = (document.getElementById('strengths').value||"").split(",").map(s=>parseFloat(s.trim())).filter(v=>!isNaN(v)&&v>0);
  const intervalDays = Math.max(1, parseInt(document.getElementById('intervalDays').value||7,10));

  const n = parseInt(document.getElementById('numTimes').value||1,10);
  let times = [];
  for (let i=0;i<n;i++) {
    const label = document.getElementById(`label_${i}`)?.value || `Time ${i+1}`;
    const start = parseFloat(document.getElementById(`start_${i}`)?.value);
    const target = parseFloat(document.getElementById(`target_${i}`)?.value);
    const mode = document.getElementById(`mode_${i}`)?.value;
    const step = parseFloat(document.getElementById(`step_${i}`)?.value);
    times.push({ label, start, target, mode, step });
  }

  const out = document.getElementById('output');
  out.innerHTML = "";

  let current = times.map(t=>t.start);
  let done = () => times.every((t,i)=> t.mode==='down'? current[i]<=t.target : (t.mode==='up'? current[i]>=t.target : true));

  let grouped = [];
  let lastText=null, lastStart=1, lastCycle=1;
  let cycle=1, dayStart=1;

  while (!done() && cycle < 500) {
    const parts = times.map((t,i)=>{
      const dose=current[i];
      return dose>0 ? `${dose}mg every ${t.label.toUpperCase()}` : null;
    }).filter(Boolean);

    const text = parts.length ? parts.join(" and ") : "No dose scheduled.";

    if (lastText===text) {
      // extend range only
    } else {
      if (lastText!==null) {
        const labelRange = (lastStart===lastCycle)?`Week ${lastCycle}`:`Week ${lastStart} to Week ${lastCycle}`;
        grouped.push(`${labelRange}: ${lastText}`);
      }
      lastText=text;
      lastStart=cycle;
    }

    // step forward
    current=current.map((val,i)=>{
      const t=times[i];
      if (t.mode==='down'&&val>t.target) return Math.max(t.target,val-t.step);
      if (t.mode==='up'&&val<t.target) return Math.min(t.target,val+t.step);
      return val;
    });

    lastCycle=cycle;
    cycle++;
  }

  if (lastText!==null) {
    const labelRange=(lastStart===lastCycle)?`Week ${lastCycle}`:`Week ${lastStart} to Week ${lastCycle}`;
    grouped.push(`${labelRange}: ${lastText}`);
  }

  grouped.forEach(line=>{
    const div=document.createElement('div');
    div.textContent=line;
    out.appendChild(div);
  });
}

document.getElementById('buildBtn').addEventListener('click', buildSchedule);
</script>
</body>
</html>
